<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Puppets NFT - Admin Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5rem;
        }

        .wallet-connect {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
        }

        .connect-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 25px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .connect-btn:hover {
            transform: translateY(-2px);
        }

        .connect-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .claim-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 25px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: transform 0.2s;
            margin-top: 20px;
        }

        .claim-btn:hover {
            transform: translateY(-2px);
        }

        .claim-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .stat-title {
            color: #666;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .stat-value {
            color: #333;
            font-size: 2rem;
            font-weight: bold;
        }

        .treasury-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .royalty-card {
            background: linear-gradient(135deg, #d4fc79 0%, #96e6a1 100%);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .treasury-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #333;
        }

        .address-display {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            word-break: break-all;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

        .balance-display {
            font-size: 2.5rem;
            color: #667eea;
            font-weight: bold;
            margin: 20px 0;
        }

        .royalty-balance {
            font-size: 3rem;
            color: #28a745;
            font-weight: bold;
            margin: 20px 0;
            text-align: center;
        }

        .success {
            background: #d4edda;
            border-left: 4px solid #28a745;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            color: #155724;
        }

        .note {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }

        .note-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: #856404;
        }

        .note-text {
            color: #856404;
            font-size: 0.9rem;
        }

        .error {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            color: #721c24;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        .explorer-link {
            color: #667eea;
            text-decoration: none;
            font-size: 0.9rem;
        }

        .explorer-link:hover {
            text-decoration: underline;
        }

        .install-warning {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .install-warning h2 {
            margin-bottom: 15px;
            font-size: 1.5rem;
        }

        .install-warning ol {
            margin: 15px 0 15px 25px;
            line-height: 1.8;
        }

        .install-warning a {
            color: white;
            font-weight: bold;
            text-decoration: underline;
        }

        .install-btn {
            background: white;
            color: #ee5a6f;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
            transition: transform 0.2s;
        }

        .install-btn:hover {
            transform: translateY(-2px);
        }

    </style>
</head>
<body>
    <div class="container">
        <h1>Puppets NFT Admin Dashboard</h1>


        <!-- Installation Warning (shown when no wallet detected) -->
        <div id="installWarning" class="install-warning hidden">
            <h2>‚ö†Ô∏è No Sui Wallet Detected</h2>
            <p><strong>Already have Phantom or Sui Wallet?</strong> Try these steps:</p>
            <ol>
                <li><strong>Check if extension is enabled:</strong>
                    <ul style="margin-top: 5px; margin-left: 20px;">
                        <li>Go to <code>chrome://extensions</code> (or your browser's extensions page)</li>
                        <li>Find "Sui Wallet" and make sure it's <strong>toggled ON</strong></li>
                    </ul>
                </li>
                <li><strong>Refresh this page</strong> (Ctrl+Shift+R or Cmd+Shift+R)</li>
                <li>Or click the button below to check again</li>
            </ol>
            <button id="refreshWalletBtn" class="install-btn" style="background: #4CAF50; color: white; margin-bottom: 10px;">
                üîÑ Check for Wallet Again
            </button>
            <p style="margin: 15px 0 10px 0;"><strong>Don't have Sui Wallet yet?</strong></p>
            <a href="https://chromewebstore.google.com/detail/sui-wallet/opcgpfmipidbgpenhmajoajpbobppdil" target="_blank">
                <button class="install-btn">üì• Install Sui Wallet Extension</button>
            </a>
            <p style="margin-top: 15px; font-size: 0.9rem; opacity: 0.9;">
                ‚úÖ Works with Chrome, Brave, Edge, and other Chromium browsers
            </p>
            <details style="margin-top: 15px; background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px;">
                <summary style="cursor: pointer; font-weight: bold;">üîß Advanced Troubleshooting</summary>
                <ul style="margin-top: 10px; line-height: 1.8;">
                    <li><strong>Supported Wallets:</strong> Phantom (with Sui support) or Sui Wallet</li>
                    <li>If using Phantom, make sure Sui chain is enabled in settings</li>
                    <li>Try disabling other wallet extensions temporarily</li>
                    <li>Restart your browser completely</li>
                    <li>Clear browser cache and reload</li>
                    <li>Check browser console (F12) for errors</li>
                </ul>
            </details>
        </div>

        <div class="wallet-connect">
            <button id="connectButton" class="connect-btn">Connect Sui Wallet</button>
            <div id="walletInfo" class="hidden">
                <p style="margin-top: 15px; color: #666;">Connected: <span id="connectedAddress" style="font-family: monospace;"></span></p>
            </div>
        </div>

        <div id="content" class="hidden">
            <!-- Royalty Rewards Card -->
            <div class="royalty-card">
                <h2 class="treasury-title">üí∞ Royalty Rewards Available</h2>

                <div class="royalty-balance" id="royaltyBalance">
                    <div class="spinner"></div>
                </div>

                <div style="text-align: center;">
                    <button id="claimButton" class="claim-btn" disabled>Claim Royalties</button>
                </div>

                <div id="claimStatus" class="hidden"></div>

                <div style="margin-top: 20px; font-size: 0.85rem; color: #333;">
                    <p><strong>TransferPolicy ID:</strong></p>
                    <div class="address-display" style="background: rgba(255,255,255,0.7);">
                        0x253c5bf8e47014358e1845305b2e133cc2106e24dce1760a4cb2cedb2e0c8032
                    </div>
                    <a href="https://suiscan.xyz/mainnet/object/0x253c5bf8e47014358e1845305b2e133cc2106e24dce1760a4cb2cedb2e0c8032"
                       class="explorer-link" target="_blank">View on SuiScan</a>
                </div>
            </div>

            <div class="treasury-card">
                <h2 class="treasury-title">Treasury Information</h2>

                <p style="margin-bottom: 10px; color: #666;">Treasury Address:</p>
                <div class="address-display" id="treasuryAddress">Loading...</div>
                <a id="treasuryExplorer" class="explorer-link" href="#" target="_blank">View on Sui Explorer</a>

                <p style="margin: 30px 0 10px 0; color: #666;">Current Treasury Balance:</p>
                <div class="balance-display" id="treasuryBalance">
                    <div class="spinner"></div>
                </div>

                <div class="note">
                    <div class="note-title">Note</div>
                    <div class="note-text">
                        Minting fees are sent directly to the treasury address. To access these funds, you need the wallet that controls the treasury address.
                    </div>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-title">Total Minted</div>
                    <div class="stat-value" id="totalMinted">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Premint Minted</div>
                    <div class="stat-value" id="premintMinted">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Phase 1 Minted</div>
                    <div class="stat-value" id="phase1Minted">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Phase 2 Minted</div>
                    <div class="stat-value" id="phase2Minted">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Phase 3 Minted</div>
                    <div class="stat-value" id="phase3Minted">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Public Minted</div>
                    <div class="stat-value" id="publicMinted">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Remaining NFTs</div>
                    <div class="stat-value" id="remainingNFTs">-</div>
                </div>
            </div>

            <div class="treasury-card">
                <h2 class="treasury-title">Contract Information</h2>
                <p style="margin-bottom: 10px; color: #666;">Package ID:</p>
                <div class="address-display">0xefb46efef2715424b184462c4e3c831456909efe2fbe72b20e4f80e1bd80ce03</div>
                <a href="https://suiscan.xyz/mainnet/object/0xefb46efef2715424b184462c4e3c831456909efe2fbe72b20e4f80e1bd80ce03" class="explorer-link" target="_blank">View Package on SuiScan</a>

                <p style="margin-top: 20px; margin-bottom: 10px; color: #666;">NFTCollection ID:</p>
                <div class="address-display">0x551188baec211f18e0fb58fa78adfe7ce8eb695bcb545ef2206d7b20a2f373bc</div>
                <a href="https://suiscan.xyz/mainnet/object/0x551188baec211f18e0fb58fa78adfe7ce8eb695bcb545ef2206d7b20a2f373bc" class="explorer-link" target="_blank">View Collection on SuiScan</a>
            </div>
        </div>
    </div>

    <script type="module">
        // Enable verbose logging
        console.log('üöÄ Puppets NFT Admin Dashboard - Initializing...');

        // Import Mysten Wallet Standard
        import { getWallets as getMystenWallets } from 'https://esm.sh/@mysten/wallet-standard@0.12.0';

        console.log('üì¶ Mysten Wallet Standard loaded');

        const PACKAGE_ID = "0xefb46efef2715424b184462c4e3c831456909efe2fbe72b20e4f80e1bd80ce03";
        const NFT_COLLECTION_ID = "0x551188baec211f18e0fb58fa78adfe7ce8eb695bcb545ef2206d7b20a2f373bc";
        const TRANSFER_POLICY_ID = "0x253c5bf8e47014358e1845305b2e133cc2106e24dce1760a4cb2cedb2e0c8032";
        const TRANSFER_POLICY_CAP_ID = "0xf3f42d23f43919b6deb36af6c67bed6c0e4b29a5c9577843021d2d6e59e21b32";
        const RPC_URL = "https://fullnode.mainnet.sui.io:443";

        console.log('üìù Contract IDs loaded:', {
            PACKAGE_ID,
            NFT_COLLECTION_ID,
            TRANSFER_POLICY_ID,
            TRANSFER_POLICY_CAP_ID
        });

        let currentAccount = null;
        let currentWallet = null;
        let royaltyBalance = 0;

        // Listen for wallet registration events
        console.log('üéß Setting up wallet registration listeners...');

        // Wallet Standard event listener
        window.addEventListener('wallet-standard:app-ready', () => {
            console.log('üì¢ wallet-standard:app-ready event fired');
            setTimeout(() => {
                console.log('Checking wallets after app-ready...');
                const wallets = getWallets();
                console.log('Found wallets:', wallets.map(w => w.name));
            }, 100);
        });

        window.addEventListener('wallet-standard:register-wallet', (event) => {
            console.log('üì¢ wallet-standard:register-wallet event fired:', event.detail);
        });

        // Detect wallet on page load
        console.log('üîç Checking for Sui Wallets...');
        console.log('window.phantom:', window.phantom);
        console.log('window.phantom?.sui:', window.phantom?.sui);
        console.log('window.suiWallet:', window.suiWallet);
        console.log('window.wallets:', window.wallets);

        // Check if window.wallets has the get method and what it returns
        if (window.wallets) {
            console.log('window.wallets type:', typeof window.wallets);
            console.log('window.wallets keys:', Object.keys(window.wallets));
            console.log('window.wallets.get type:', typeof window.wallets.get);

            if (typeof window.wallets.get === 'function') {
                const walletsFromGet = window.wallets.get();
                console.log('window.wallets.get() returned:', walletsFromGet);
                console.log('window.wallets.get() length:', walletsFromGet?.length);
                if (walletsFromGet) {
                    walletsFromGet.forEach((w, i) => {
                        console.log(`  Wallet ${i}:`, w.name, w);
                    });
                }
            }
        }

        console.log('window.suiet:', window.suiet);
        console.log('window.slush:', window.slush);
        console.log('All window properties with "sui":', Object.keys(window).filter(k => k.toLowerCase().includes('sui')));
        console.log('All window properties with "wallet":', Object.keys(window).filter(k => k.toLowerCase().includes('wallet')));

        // Re-check after a delay to see if wallets injected late
        setTimeout(() => {
            console.log('\nüîÑ Re-checking wallet detection after 2 seconds...');
            console.log('window.wallets:', window.wallets);
            console.log('window.suiet:', window.suiet);
            console.log('window.slush:', window.slush);

            // Check if Mysten library detects any new wallets
            const wallets = getWallets();
            console.log(`Found ${wallets.length} Sui wallets:`, wallets.map(w => w.name));
        }, 2000);

        // Helper to create wallet wrapper for standard interface
        function createWalletWrapper(name, walletApi) {
            console.log(`üîß Creating wrapper for ${name}`);
            console.log(`  Available methods:`, Object.keys(walletApi));

            return {
                name: name,
                version: '1.0.0',
                icon: '',
                chains: ['sui:mainnet'],
                features: {
                    'standard:connect': {
                        connect: async () => {
                            console.log(`üîå Connecting to ${name}...`);

                            try {
                                let resp;

                                // Try different connection methods
                                if (typeof walletApi.connect === 'function') {
                                    console.log(`  Using connect() for ${name}`);
                                    resp = await walletApi.connect();
                                } else if (typeof walletApi.requestAccount === 'function') {
                                    console.log(`  Using requestAccount() for ${name}`);
                                    resp = await walletApi.requestAccount();
                                } else if (typeof walletApi.requestAccounts === 'function') {
                                    console.log(`  Using requestAccounts() for ${name}`);
                                    resp = await walletApi.requestAccounts();
                                } else if (typeof walletApi.getAccounts === 'function') {
                                    console.log(`  Using getAccounts() for ${name}`);
                                    resp = await walletApi.getAccounts();
                                } else {
                                    throw new Error(`No known connection method found on ${name}`);
                                }

                                console.log(`‚úÖ ${name} connected:`, resp);

                                // Handle different response formats
                                let address, publicKey;
                                if (Array.isArray(resp) && resp.length > 0) {
                                    address = resp[0].address || resp[0];
                                    publicKey = resp[0].publicKey;
                                } else if (resp.address) {
                                    address = resp.address;
                                    publicKey = resp.publicKey;
                                } else if (resp.accounts && resp.accounts.length > 0) {
                                    address = resp.accounts[0].address;
                                    publicKey = resp.accounts[0].publicKey;
                                } else {
                                    throw new Error(`Unknown response format from ${name}: ` + JSON.stringify(resp));
                                }

                                return {
                                    accounts: [{
                                        address: address,
                                        publicKey: publicKey,
                                        chains: ['sui:mainnet']
                                    }]
                                };
                            } catch (err) {
                                console.error(`‚ùå ${name} connection failed:`, err);
                                throw err;
                            }
                        }
                    },
                    'standard:events': {
                        on: (event, handler) => {
                            if (typeof walletApi.on === 'function') {
                                walletApi.on(event, handler);
                            }
                        }
                    },
                    'sui:signAndExecuteTransactionBlock': {
                        signAndExecuteTransactionBlock: async ({ transactionBlock, account, chain }) => {
                            console.log(`üîê Signing transaction with ${name}...`);

                            try {
                                let result;

                                // Try different signing methods
                                if (typeof walletApi.signAndExecuteTransactionBlock === 'function') {
                                    console.log(`  Using signAndExecuteTransactionBlock() for ${name}`);
                                    result = await walletApi.signAndExecuteTransactionBlock({
                                        transactionBlock: transactionBlock,
                                        options: {
                                            showEffects: true,
                                            showObjectChanges: true
                                        }
                                    });
                                } else if (typeof walletApi.signAndExecuteTransaction === 'function') {
                                    console.log(`  Using signAndExecuteTransaction() for ${name}`);
                                    result = await walletApi.signAndExecuteTransaction({
                                        transaction: transactionBlock,
                                        options: {
                                            showEffects: true,
                                            showObjectChanges: true
                                        }
                                    });
                                } else {
                                    throw new Error(`No known signing method found on ${name}`);
                                }

                                console.log(`‚úÖ Transaction signed with ${name}:`, result);
                                return result;
                            } catch (err) {
                                console.error(`‚ùå Transaction signing failed with ${name}:`, err);
                                throw err;
                            }
                        }
                    }
                },
                _walletApi: walletApi // Store reference
            };
        }

        // Helper function to get available wallets using Mysten Wallet Standard
        function getWallets() {
            console.log('üîç Getting available wallets using Mysten Wallet Standard...');

            try {
                const walletsApi = getMystenWallets();
                console.log('üì¶ Wallets API:', walletsApi);

                // Get registered wallets
                const registeredWallets = walletsApi.get();
                console.log('üíº Registered wallets (raw):', registeredWallets);
                console.log(`üìä Total wallets found (raw): ${registeredWallets.length}`);

                registeredWallets.forEach((w, i) => {
                    console.log(`  ${i + 1}. ${w.name} (v${w.version})`);
                    console.log(`     Chains: ${w.chains.join(', ')}`);
                    console.log(`     Features: ${Object.keys(w.features).join(', ')}`);
                });

                // Filter to only Sui-compatible wallets
                const suiWallets = registeredWallets.filter(wallet => {
                    const hasSuiChain = wallet.chains.some(chain =>
                        chain.startsWith('sui:') || chain.toLowerCase().includes('sui')
                    );
                    if (hasSuiChain) {
                        console.log(`  ‚úì ${wallet.name} supports Sui`);
                    } else {
                        console.log(`  ‚úó ${wallet.name} does NOT support Sui (chains: ${wallet.chains.join(', ')})`);
                    }
                    return hasSuiChain;
                });

                // Deduplicate by wallet name (Phantom registers 3 times for different chains)
                const uniqueWallets = [];
                const seenNames = new Set();

                suiWallets.forEach(wallet => {
                    if (!seenNames.has(wallet.name)) {
                        uniqueWallets.push(wallet);
                        seenNames.add(wallet.name);
                        console.log(`  ‚ûï Added ${wallet.name} to list`);
                    } else {
                        console.log(`  ‚è≠Ô∏è  Skipped duplicate ${wallet.name}`);
                    }
                });

                console.log(`\n‚úÖ Final Sui wallet count (from Wallet Standard): ${uniqueWallets.length}`);
                uniqueWallets.forEach((w, i) => console.log(`  ${i + 1}. ${w.name}`));

                // Manual fallback detection for wallets that don't use Wallet Standard
                console.log('\nüîç Checking for wallets via manual detection (window properties)...');
                const manualWallets = [];
                const manualChecks = [
                    { key: 'suiet', name: 'Suiet' },
                    { key: 'slush', name: 'Slush' },
                    { key: 'suiWallet', name: 'Sui Wallet' },
                    { key: 'ethos', name: 'Ethos' },
                    { key: 'martian', name: 'Martian' }
                ];

                for (const { key, name } of manualChecks) {
                    if (window[key]) {
                        console.log(`  ‚úì Found window.${key} (${name})`);
                        // Check if already in uniqueWallets
                        if (!seenNames.has(name)) {
                            console.log(`    ‚ûï ${name} not in Wallet Standard, adding manually`);
                            manualWallets.push(createWalletWrapper(name, window[key]));
                            seenNames.add(name);
                        } else {
                            console.log(`    ‚è≠Ô∏è  ${name} already in Wallet Standard, skipping`);
                        }
                    } else {
                        console.log(`  ‚úó window.${key} not found`);
                    }
                }

                const finalWallets = [...uniqueWallets, ...manualWallets];
                console.log(`\nüéØ FINAL wallet count (Standard + Manual): ${finalWallets.length}`);
                finalWallets.forEach((w, i) => console.log(`  ${i + 1}. ${w.name}`));

                // Listen for new wallets
                walletsApi.on('register', (wallet) => {
                    console.log('  üì¢ New wallet registered:', wallet.name);
                });

                return finalWallets;
            } catch (error) {
                console.error('‚ùå Error getting wallets from Mysten Wallet Standard:', error);
                console.log('Falling back to Phantom-only detection...');

                // Fallback: manual Phantom detection
                if (window.phantom?.sui) {
                    console.log('‚úÖ Found Phantom via fallback');
                    return [createWalletWrapper('Phantom', window.phantom.sui)];
                }

                return [];
            }
        }

        // Store available wallets globally
        let availableWallets = [];


        // Connect to a specific wallet
        async function connectToWallet(wallet) {
            console.log('üîê Connecting to wallet:', wallet.name);
            console.log('Wallet object:', wallet);

            currentWallet = wallet;

            // Register wallet events
            if (wallet.features['standard:events']) {
                wallet.features['standard:events'].on('change', ({ accounts }) => {
                    console.log('üëõ Wallet accounts changed:', accounts);
                });
            }

            // Connect to wallet
            console.log('üîå Calling connect()...');
            const connectResult = await wallet.features['standard:connect'].connect();
            console.log('‚úÖ Connect result:', connectResult);

            if (connectResult.accounts && connectResult.accounts.length > 0) {
                currentAccount = connectResult.accounts[0];
                console.log('‚úÖ Connected account:', currentAccount);

                document.getElementById('connectedAddress').textContent =
                    currentAccount.address.slice(0, 6) + '...' + currentAccount.address.slice(-4);
                document.getElementById('walletInfo').classList.remove('hidden');
                document.getElementById('connectButton').textContent = `Connected (${wallet.name})`;
                document.getElementById('connectButton').disabled = true;
                document.getElementById('content').classList.remove('hidden');

                console.log('üìä Loading dashboard data...');
                await loadData();
            } else {
                throw new Error('No accounts returned from wallet');
            }
        }

        // Wait for wallets to register (they inject asynchronously)
        async function waitForWallets(maxWaitMs = 3000) {
            console.log('‚è≥ Waiting for wallets to register...');
            const startTime = Date.now();
            const checkInterval = 100; // Check every 100ms

            return new Promise((resolve) => {
                const check = () => {
                    const wallets = getWallets();
                    const elapsed = Date.now() - startTime;

                    if (wallets.length > 0 || elapsed >= maxWaitMs) {
                        console.log(`‚úÖ Wallet detection complete after ${elapsed}ms - found ${wallets.length} wallet(s)`);
                        resolve(wallets);
                    } else {
                        setTimeout(check, checkInterval);
                    }
                };
                check();
            });
        }

        // Connect wallet button handler
        document.getElementById('connectButton').addEventListener('click', async () => {
            console.log('üëÜ Connect button clicked');

            try {
                console.log('üîç Checking wallet availability...');

                // Check all possible wallet APIs
                const walletProviders = {
                    phantom: window.phantom,
                    wallets: window.wallets,
                    suiWallets: window.suiWallets,
                    suiWallet: window.suiWallet,
                    suiet: window.suiet,
                    slush: window.slush
                };
                console.log('üì¶ Available wallet providers:', walletProviders);

                // Wait for wallets to register (they load async)
                console.log('‚è≥ Waiting for wallets...');
                const wallets = await waitForWallets(3000);
                availableWallets = wallets;

                console.log('üìä Wallet detection complete:', wallets);
                console.log('  Total found:', wallets.length);
                if (wallets.length > 0) {
                    console.log('  Wallet names:', wallets.map(w => w.name).join(', '));
                }

                if (wallets && wallets.length > 0) {
                    console.log(`‚úÖ Found ${wallets.length} wallet(s)`);

                    // Connect to first detected wallet
                    const wallet = wallets[0];
                    console.log(`üîå Connecting directly to ${wallet.name}...`);
                    await connectToWallet(wallet);

                } else {
                    console.error('‚ùå No Sui Wallet detected');
                    console.log('Please install a Sui Wallet extension');

                    // Show the installation warning
                    document.getElementById('installWarning').classList.remove('hidden');

                    alert('‚ö†Ô∏è Sui Wallet Extension Required\n\n' +
                        'You need to install a Sui Wallet browser extension first.\n\n' +
                        'Supported wallets:\n' +
                        '‚Ä¢ Sui Wallet\n' +
                        '‚Ä¢ Suiet Wallet\n' +
                        '‚Ä¢ Phantom (with Sui enabled)\n' +
                        '‚Ä¢ Slush Wallet\n\n' +
                        'After installing, refresh this page and try again.');
                    return;
                }
            } catch (error) {
                console.error('‚ùå Wallet connection error:', error);
                console.error('Error stack:', error.stack);

                let errorMsg = error.message;
                if (error.message.includes('User rejected')) {
                    errorMsg = 'You rejected the connection request';
                }

                alert('Failed to connect wallet: ' + errorMsg + '\n\nCheck console for details (F12)');
            }
        });

        async function rpcCall(method, params) {
            console.log(`üåê RPC Call: ${method}`, params);
            try {
                const response = await fetch(RPC_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        jsonrpc: '2.0',
                        id: 1,
                        method,
                        params
                    })
                });
                const data = await response.json();
                console.log(`‚úÖ RPC Response: ${method}`, data);

                if (data.error) {
                    console.error(`‚ùå RPC Error: ${method}`, data.error);
                    throw new Error(data.error.message);
                }
                return data.result;
            } catch (error) {
                console.error(`‚ùå RPC Call failed: ${method}`, error);
                throw error;
            }
        }

        async function loadRoyaltyBalance() {
            console.log('üí∞ Loading royalty balance...');
            try {
                const policyData = await rpcCall('sui_getObject', [
                    TRANSFER_POLICY_ID,
                    { showContent: true }
                ]);

                console.log('üì¶ TransferPolicy data:', policyData);

                const balance = policyData.data.content.fields.balance;
                royaltyBalance = parseInt(balance);
                const suiBalance = (royaltyBalance / 1_000_000_000).toFixed(2);

                console.log(`üíµ Royalty balance: ${royaltyBalance} MIST (${suiBalance} SUI)`);

                document.getElementById('royaltyBalance').textContent = `${suiBalance} SUI`;

                // Check if user owns the TransferPolicyCap
                console.log('üîë Checking TransferPolicyCap ownership...');
                const capData = await rpcCall('sui_getObject', [
                    TRANSFER_POLICY_CAP_ID,
                    { showOwner: true }
                ]);

                console.log('üìã TransferPolicyCap data:', capData);

                const capOwner = capData.data.owner?.AddressOwner;
                console.log('üë§ Cap owner:', capOwner);
                console.log('üë§ Current account:', currentAccount?.address);

                if (capOwner && currentAccount && capOwner === currentAccount.address) {
                    console.log('‚úÖ User owns the TransferPolicyCap - enabling claim button');
                    document.getElementById('claimButton').disabled = false;
                } else {
                    console.log('‚ùå User does NOT own the TransferPolicyCap - disabling claim button');
                    document.getElementById('claimButton').disabled = true;
                    const statusEl = document.getElementById('claimStatus');
                    statusEl.className = 'note';
                    statusEl.innerHTML = `
                        <div class="note-title">Permission Required</div>
                        <div class="note-text">
                            You need the TransferPolicyCap to claim royalties.<br>
                            Cap Owner: ${capOwner ? capOwner.slice(0, 10) + '...' + capOwner.slice(-8) : 'Unknown'}<br>
                            Your Address: ${currentAccount?.address ? currentAccount.address.slice(0, 10) + '...' + currentAccount.address.slice(-8) : 'Not connected'}
                        </div>
                    `;
                    statusEl.classList.remove('hidden');
                }
            } catch (error) {
                console.error('‚ùå Error loading royalty balance:', error);
                console.error('Error stack:', error.stack);
                document.getElementById('royaltyBalance').textContent = 'Error loading';
            }
        }

        async function loadCollectionStats() {
            console.log('üìä Loading collection stats...');
            try {
                const collectionData = await rpcCall('sui_getObject', [
                    NFT_COLLECTION_ID,
                    { showContent: true }
                ]);

                console.log('üì¶ Collection data:', collectionData);

                const fields = collectionData.data.content.fields;
                console.log('üìù Collection fields:', fields);

                document.getElementById('totalMinted').textContent = fields.minted;
                document.getElementById('premintMinted').textContent = fields.premint_minted;
                document.getElementById('phase1Minted').textContent = fields.phase1_minted;
                document.getElementById('phase2Minted').textContent = fields.phase2_minted;
                document.getElementById('phase3Minted').textContent = fields.phase3_minted;
                document.getElementById('publicMinted').textContent = fields.public_minted;
                document.getElementById('remainingNFTs').textContent = fields.available_ids.length;

                console.log('‚úÖ Collection stats updated');

                // Get treasury address
                const treasuryAddr = fields.treasury_address;
                console.log('üè¶ Treasury address:', treasuryAddr);

                document.getElementById('treasuryAddress').textContent = treasuryAddr;
                document.getElementById('treasuryExplorer').href =
                    `https://suiscan.xyz/mainnet/account/${treasuryAddr}`;

                // Get treasury balance
                console.log('üí∞ Fetching treasury balance...');
                const balance = await rpcCall('suix_getBalance', [
                    treasuryAddr,
                    '0x2::sui::SUI'
                ]);

                const suiBalance = (parseInt(balance.totalBalance) / 1_000_000_000).toFixed(2);
                console.log(`üíµ Treasury balance: ${balance.totalBalance} MIST (${suiBalance} SUI)`);

                document.getElementById('treasuryBalance').textContent = `${suiBalance} SUI`;
                console.log('‚úÖ Treasury stats updated');
            } catch (error) {
                console.error('‚ùå Error loading stats:', error);
                console.error('Error stack:', error.stack);
                document.getElementById('treasuryBalance').textContent = 'Error loading';
            }
        }

        async function claimRoyalties() {
            console.log('üí∏ Starting royalty claim process...');
            try {
                if (!currentWallet || !currentAccount) {
                    throw new Error('Wallet not connected');
                }

                document.getElementById('claimButton').disabled = true;
                document.getElementById('claimButton').textContent = 'Processing...';

                const statusEl = document.getElementById('claimStatus');
                statusEl.className = 'note';
                statusEl.innerHTML = '<div class="note-text">Building transaction...</div>';
                statusEl.classList.remove('hidden');

                console.log('üî® Building transaction block...');
                console.log('Current wallet:', currentWallet.name);
                console.log('Current account:', currentAccount.address);

                // Build transaction using Transaction builder
                const txb = {
                    kind: 'moveCall',
                    data: {
                        packageObjectId: '0x2',
                        module: 'transfer_policy',
                        function: 'withdraw',
                        typeArguments: [`${PACKAGE_ID}::puppets::PUPPETS_NFT`],
                        arguments: [
                            TRANSFER_POLICY_ID,
                            TRANSFER_POLICY_CAP_ID,
                            null // amount (null means withdraw all)
                        ],
                        gasBudget: 10000000
                    }
                };

                console.log('üìù Transaction block:', txb);

                statusEl.innerHTML = '<div class="note-text">Waiting for wallet approval...</div>';
                console.log('‚è≥ Waiting for user approval in wallet...');

                // Sign and execute transaction using Wallet Standard API
                const signAndExecuteFeature = currentWallet.features['sui:signAndExecuteTransactionBlock'];

                if (!signAndExecuteFeature) {
                    throw new Error('Wallet does not support transaction signing');
                }

                console.log('üîê Signing and executing transaction...');

                const result = await signAndExecuteFeature.signAndExecuteTransactionBlock({
                    transactionBlock: txb,
                    account: currentAccount,
                    chain: 'sui:mainnet'
                });

                console.log('‚úÖ Transaction result:', result);

                statusEl.className = 'success';
                statusEl.innerHTML = `
                    <div style="font-weight: bold; margin-bottom: 5px;">‚úÖ Royalties Claimed Successfully!</div>
                    <div>Transaction: <a href="https://suiscan.xyz/mainnet/tx/${result.digest}"
                         target="_blank" style="color: #155724; text-decoration: underline;">
                        ${result.digest.slice(0, 10)}...${result.digest.slice(-8)}
                    </a></div>
                `;

                console.log('üîÑ Reloading balances in 2 seconds...');
                // Reload balances
                setTimeout(() => {
                    loadData();
                }, 2000);

            } catch (error) {
                console.error('‚ùå Error claiming royalties:', error);
                console.error('Error stack:', error.stack);

                let errorMsg = error.message;
                if (error.message.includes('User rejected')) {
                    errorMsg = 'You rejected the transaction';
                }

                const statusEl = document.getElementById('claimStatus');
                statusEl.className = 'error';
                statusEl.innerHTML = `Failed to claim: ${errorMsg}`;

                document.getElementById('claimButton').disabled = false;
                document.getElementById('claimButton').textContent = 'Claim Royalties';
            }
        }

        async function loadData() {
            console.log('üìä Loading all dashboard data...');
            try {
                await Promise.all([
                    loadRoyaltyBalance(),
                    loadCollectionStats()
                ]);
                console.log('‚úÖ All data loaded successfully');
            } catch (error) {
                console.error('‚ùå Error loading data:', error);
            }
        }

        // Claim button handler
        console.log('üîò Setting up claim button handler...');
        document.getElementById('claimButton').addEventListener('click', claimRoyalties);

        // Refresh wallet detection handler
        document.getElementById('refreshWalletBtn').addEventListener('click', () => {
            console.log('üîÑ Manual wallet refresh requested');

            const btn = document.getElementById('refreshWalletBtn');
            btn.disabled = true;
            btn.textContent = 'üîç Checking...';

            setTimeout(() => {
                console.log('üîç Re-checking for wallets...');
                console.log('window.phantom:', window.phantom);
                console.log('window.phantom?.sui:', window.phantom?.sui);
                console.log('window.wallets:', window.wallets);
                console.log('window.suiWallet:', window.suiWallet);

                const wallets = getWallets();

                if (wallets.length > 0) {
                    console.log('‚úÖ Wallet(s) detected!');
                    const walletNames = wallets.map(w => w.name).join(', ');
                    alert('‚úÖ Sui Wallet(s) Detected!\n\nFound: ' + walletNames + '\n\nRefreshing page...');
                    location.reload();
                } else {
                    console.error('‚ùå Still no wallet detected');

                    let message = '‚ùå Still No Wallet Detected\n\n';
                    message += 'Diagnostic Info:\n';
                    message += '- window.phantom: ' + (typeof window.phantom) + '\n';
                    message += '- window.phantom?.sui: ' + (typeof window.phantom?.sui) + '\n';
                    message += '- window.wallets: ' + (typeof window.wallets) + '\n';
                    message += '- window.suiWallet: ' + (typeof window.suiWallet) + '\n\n';
                    message += 'Supported Wallets:\n';
                    message += '- Phantom (with Sui support)\n';
                    message += '- Sui Wallet\n';
                    message += '- Any Wallet Standard compatible wallet\n\n';
                    message += 'Please try:\n';
                    message += '1. Go to chrome://extensions\n';
                    message += '2. Make sure your wallet is ENABLED (toggle ON)\n';
                    message += '3. Restart your browser\n';
                    message += '4. Come back to this page';

                    alert(message);

                    btn.disabled = false;
                    btn.textContent = 'üîÑ Check for Wallet Again';
                }
            }, 500);
        });

        // Auto-detect Sui Wallet on page load
        window.addEventListener('load', () => {
            console.log('üåç Window loaded, checking for Sui Wallets...');
            console.log('window.phantom:', window.phantom);
            console.log('window.phantom?.sui:', window.phantom?.sui);
            console.log('window.wallets:', window.wallets);
            console.log('window.suiWallet:', window.suiWallet);

            // Give wallet extensions time to inject
            setTimeout(() => {
                console.log('‚è∞ Delayed wallet check (after 1000ms)...');
                console.log('window.phantom:', window.phantom);
                console.log('window.phantom?.sui:', window.phantom?.sui);
                console.log('window.wallets:', window.wallets);
                console.log('window.suiWallet:', window.suiWallet);

                // Check for all wallets
                const wallets = getWallets();
                const hasWallet = wallets.length > 0;

                if (!hasWallet) {
                    console.warn('‚ö†Ô∏è No Sui Wallets detected on page load');
                    console.log('Debug info:');
                    console.log('- typeof window.phantom:', typeof window.phantom);
                    console.log('- typeof window.phantom?.sui:', typeof window.phantom?.sui);
                    console.log('- typeof window.wallets:', typeof window.wallets);
                    console.log('- window.wallets?.get:', window.wallets?.get);

                    // Show prominent installation warning
                    document.getElementById('installWarning').classList.remove('hidden');

                    // Disable connect button
                    const connectBtn = document.getElementById('connectButton');
                    connectBtn.disabled = true;
                    connectBtn.textContent = 'No Wallet Detected';
                    connectBtn.style.opacity = '0.5';
                } else {
                    console.log('‚úÖ Sui Wallets detected on page load');
                    console.log(`Found ${wallets.length} wallet(s):`, wallets.map(w => w.name));

                    // Hide installation warning if wallet is detected
                    document.getElementById('installWarning').classList.add('hidden');

                    // Update button text if Phantom is the only wallet
                    if (wallets.length === 1 && wallets[0].name === 'Phantom') {
                        document.getElementById('connectButton').textContent = 'Connect Phantom Wallet';
                    }
                }
            }, 1000); // Increased to 1 second to give more time for extension to load
        });

        console.log('‚úÖ Dashboard initialization complete');
    </script>
</body>
</html>
