<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Puppets NFT - Admin Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5rem;
        }

        .wallet-connect {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
        }

        .connect-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 25px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .connect-btn:hover {
            transform: translateY(-2px);
        }

        .connect-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .claim-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 25px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: transform 0.2s;
            margin-top: 20px;
        }

        .claim-btn:hover {
            transform: translateY(-2px);
        }

        .claim-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .stat-title {
            color: #666;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .stat-value {
            color: #333;
            font-size: 2rem;
            font-weight: bold;
        }

        .treasury-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .royalty-card {
            background: linear-gradient(135deg, #d4fc79 0%, #96e6a1 100%);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .treasury-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #333;
        }

        .address-display {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            word-break: break-all;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

        .balance-display {
            font-size: 2.5rem;
            color: #667eea;
            font-weight: bold;
            margin: 20px 0;
        }

        .royalty-balance {
            font-size: 3rem;
            color: #28a745;
            font-weight: bold;
            margin: 20px 0;
            text-align: center;
        }

        .success {
            background: #d4edda;
            border-left: 4px solid #28a745;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            color: #155724;
        }

        .note {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }

        .note-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: #856404;
        }

        .note-text {
            color: #856404;
            font-size: 0.9rem;
        }

        .error {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            color: #721c24;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        .explorer-link {
            color: #667eea;
            text-decoration: none;
            font-size: 0.9rem;
        }

        .explorer-link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Puppets NFT Admin Dashboard</h1>

        <div class="wallet-connect">
            <button id="connectButton" class="connect-btn">Connect Sui Wallet</button>
            <div id="walletInfo" class="hidden">
                <p style="margin-top: 15px; color: #666;">Connected: <span id="connectedAddress" style="font-family: monospace;"></span></p>
            </div>
        </div>

        <div id="content" class="hidden">
            <!-- Royalty Rewards Card -->
            <div class="royalty-card">
                <h2 class="treasury-title">💰 Royalty Rewards Available</h2>

                <div class="royalty-balance" id="royaltyBalance">
                    <div class="spinner"></div>
                </div>

                <div style="text-align: center;">
                    <button id="claimButton" class="claim-btn" disabled>Claim Royalties</button>
                </div>

                <div id="claimStatus" class="hidden"></div>

                <div style="margin-top: 20px; font-size: 0.85rem; color: #333;">
                    <p><strong>TransferPolicy ID:</strong></p>
                    <div class="address-display" style="background: rgba(255,255,255,0.7);">
                        0x253c5bf8e47014358e1845305b2e133cc2106e24dce1760a4cb2cedb2e0c8032
                    </div>
                    <a href="https://suiscan.xyz/mainnet/object/0x253c5bf8e47014358e1845305b2e133cc2106e24dce1760a4cb2cedb2e0c8032"
                       class="explorer-link" target="_blank">View on SuiScan</a>
                </div>
            </div>

            <div class="treasury-card">
                <h2 class="treasury-title">Treasury Information</h2>

                <p style="margin-bottom: 10px; color: #666;">Treasury Address:</p>
                <div class="address-display" id="treasuryAddress">Loading...</div>
                <a id="treasuryExplorer" class="explorer-link" href="#" target="_blank">View on Sui Explorer</a>

                <p style="margin: 30px 0 10px 0; color: #666;">Current Treasury Balance:</p>
                <div class="balance-display" id="treasuryBalance">
                    <div class="spinner"></div>
                </div>

                <div class="note">
                    <div class="note-title">Note</div>
                    <div class="note-text">
                        Minting fees are sent directly to the treasury address. To access these funds, you need the wallet that controls the treasury address.
                    </div>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-title">Total Minted</div>
                    <div class="stat-value" id="totalMinted">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Premint Minted</div>
                    <div class="stat-value" id="premintMinted">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Phase 1 Minted</div>
                    <div class="stat-value" id="phase1Minted">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Phase 2 Minted</div>
                    <div class="stat-value" id="phase2Minted">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Phase 3 Minted</div>
                    <div class="stat-value" id="phase3Minted">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Public Minted</div>
                    <div class="stat-value" id="publicMinted">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Remaining NFTs</div>
                    <div class="stat-value" id="remainingNFTs">-</div>
                </div>
            </div>

            <div class="treasury-card">
                <h2 class="treasury-title">Contract Information</h2>
                <p style="margin-bottom: 10px; color: #666;">Package ID:</p>
                <div class="address-display">0xefb46efef2715424b184462c4e3c831456909efe2fbe72b20e4f80e1bd80ce03</div>
                <a href="https://suiscan.xyz/mainnet/object/0xefb46efef2715424b184462c4e3c831456909efe2fbe72b20e4f80e1bd80ce03" class="explorer-link" target="_blank">View Package on SuiScan</a>

                <p style="margin-top: 20px; margin-bottom: 10px; color: #666;">NFTCollection ID:</p>
                <div class="address-display">0x551188baec211f18e0fb58fa78adfe7ce8eb695bcb545ef2206d7b20a2f373bc</div>
                <a href="https://suiscan.xyz/mainnet/object/0x551188baec211f18e0fb58fa78adfe7ce8eb695bcb545ef2206d7b20a2f373bc" class="explorer-link" target="_blank">View Collection on SuiScan</a>
            </div>
        </div>
    </div>

    <script type="module">
        // Enable verbose logging
        console.log('🚀 Puppets NFT Admin Dashboard - Initializing...');

        const PACKAGE_ID = "0xefb46efef2715424b184462c4e3c831456909efe2fbe72b20e4f80e1bd80ce03";
        const NFT_COLLECTION_ID = "0x551188baec211f18e0fb58fa78adfe7ce8eb695bcb545ef2206d7b20a2f373bc";
        const TRANSFER_POLICY_ID = "0x253c5bf8e47014358e1845305b2e133cc2106e24dce1760a4cb2cedb2e0c8032";
        const TRANSFER_POLICY_CAP_ID = "0xf3f42d23f43919b6deb36af6c67bed6c0e4b29a5c9577843021d2d6e59e21b32";
        const RPC_URL = "https://fullnode.mainnet.sui.io:443";

        console.log('📝 Contract IDs loaded:', {
            PACKAGE_ID,
            NFT_COLLECTION_ID,
            TRANSFER_POLICY_ID,
            TRANSFER_POLICY_CAP_ID
        });

        let currentAccount = null;
        let currentWallet = null;
        let royaltyBalance = 0;

        // Detect wallet on page load
        console.log('🔍 Checking for Sui Wallet...');
        console.log('window.suiWallet:', window.suiWallet);
        console.log('window.suiWallets:', window.suiWallets);
        console.log('All window properties:', Object.keys(window).filter(k => k.toLowerCase().includes('sui')));

        // Helper function to get available wallets
        function getWallets() {
            console.log('🔍 Getting available wallets...');

            // Modern Wallet Standard API
            if (window.suiWallets && window.suiWallets.get) {
                console.log('✅ Using Wallet Standard API (window.suiWallets)');
                const wallets = window.suiWallets.get();
                console.log('💼 Available wallets:', wallets);
                return wallets;
            }

            console.warn('⚠️ Wallet Standard API not found');
            return [];
        }

        // Connect wallet
        document.getElementById('connectButton').addEventListener('click', async () => {
            console.log('👆 Connect button clicked');

            try {
                console.log('🔍 Checking wallet availability...');

                // Check all possible wallet APIs
                const walletProviders = {
                    suiWallets: window.suiWallets,
                    suiWallet: window.suiWallet,
                    sui: window.sui
                };
                console.log('📦 Available wallet providers:', walletProviders);

                // Try Wallet Standard API first (modern approach)
                const wallets = getWallets();

                if (wallets && wallets.length > 0) {
                    console.log('✅ Found wallets via Wallet Standard API');

                    const wallet = wallets[0];
                    console.log('🔐 Selected wallet:', wallet);
                    console.log('Wallet name:', wallet.name);
                    console.log('Wallet version:', wallet.version);

                    currentWallet = wallet;

                    // Register wallet events
                    wallet.features['standard:events'].on('change', ({ accounts }) => {
                        console.log('👛 Wallet accounts changed:', accounts);
                    });

                    // Connect to wallet
                    console.log('🔌 Connecting to wallet...');
                    const connectResult = await wallet.features['standard:connect'].connect();
                    console.log('✅ Connect result:', connectResult);

                    if (connectResult.accounts && connectResult.accounts.length > 0) {
                        currentAccount = connectResult.accounts[0];
                        console.log('✅ Connected account:', currentAccount);

                        document.getElementById('connectedAddress').textContent =
                            currentAccount.address.slice(0, 6) + '...' + currentAccount.address.slice(-4);
                        document.getElementById('walletInfo').classList.remove('hidden');
                        document.getElementById('connectButton').textContent = 'Connected';
                        document.getElementById('connectButton').disabled = true;
                        document.getElementById('content').classList.remove('hidden');

                        console.log('📊 Loading dashboard data...');
                        await loadData();
                    } else {
                        throw new Error('No accounts returned from wallet');
                    }

                } else {
                    console.error('❌ No Sui Wallet detected');
                    console.log('Please install Sui Wallet extension from:');
                    console.log('https://chromewebstore.google.com/detail/sui-wallet/opcgpfmipidbgpenhmajoajpbobppdil');

                    alert('⚠️ No Sui Wallet Detected\n\nPlease:\n1. Install Sui Wallet extension\n2. Refresh this page\n\nDownload: https://chromewebstore.google.com/detail/sui-wallet/opcgpfmipidbgpenhmajoajpbobppdil');
                    return;
                }
            } catch (error) {
                console.error('❌ Wallet connection error:', error);
                console.error('Error stack:', error.stack);

                let errorMsg = error.message;
                if (error.message.includes('User rejected')) {
                    errorMsg = 'You rejected the connection request';
                }

                alert('Failed to connect wallet: ' + errorMsg + '\n\nCheck console for details (F12)');
            }
        });

        async function rpcCall(method, params) {
            console.log(`🌐 RPC Call: ${method}`, params);
            try {
                const response = await fetch(RPC_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        jsonrpc: '2.0',
                        id: 1,
                        method,
                        params
                    })
                });
                const data = await response.json();
                console.log(`✅ RPC Response: ${method}`, data);

                if (data.error) {
                    console.error(`❌ RPC Error: ${method}`, data.error);
                    throw new Error(data.error.message);
                }
                return data.result;
            } catch (error) {
                console.error(`❌ RPC Call failed: ${method}`, error);
                throw error;
            }
        }

        async function loadRoyaltyBalance() {
            console.log('💰 Loading royalty balance...');
            try {
                const policyData = await rpcCall('sui_getObject', [
                    TRANSFER_POLICY_ID,
                    { showContent: true }
                ]);

                console.log('📦 TransferPolicy data:', policyData);

                const balance = policyData.data.content.fields.balance;
                royaltyBalance = parseInt(balance);
                const suiBalance = (royaltyBalance / 1_000_000_000).toFixed(2);

                console.log(`💵 Royalty balance: ${royaltyBalance} MIST (${suiBalance} SUI)`);

                document.getElementById('royaltyBalance').textContent = `${suiBalance} SUI`;

                // Check if user owns the TransferPolicyCap
                console.log('🔑 Checking TransferPolicyCap ownership...');
                const capData = await rpcCall('sui_getObject', [
                    TRANSFER_POLICY_CAP_ID,
                    { showOwner: true }
                ]);

                console.log('📋 TransferPolicyCap data:', capData);

                const capOwner = capData.data.owner?.AddressOwner;
                console.log('👤 Cap owner:', capOwner);
                console.log('👤 Current account:', currentAccount?.address);

                if (capOwner && currentAccount && capOwner === currentAccount.address) {
                    console.log('✅ User owns the TransferPolicyCap - enabling claim button');
                    document.getElementById('claimButton').disabled = false;
                } else {
                    console.log('❌ User does NOT own the TransferPolicyCap - disabling claim button');
                    document.getElementById('claimButton').disabled = true;
                    const statusEl = document.getElementById('claimStatus');
                    statusEl.className = 'note';
                    statusEl.innerHTML = `
                        <div class="note-title">Permission Required</div>
                        <div class="note-text">
                            You need the TransferPolicyCap to claim royalties.<br>
                            Cap Owner: ${capOwner ? capOwner.slice(0, 10) + '...' + capOwner.slice(-8) : 'Unknown'}<br>
                            Your Address: ${currentAccount?.address ? currentAccount.address.slice(0, 10) + '...' + currentAccount.address.slice(-8) : 'Not connected'}
                        </div>
                    `;
                    statusEl.classList.remove('hidden');
                }
            } catch (error) {
                console.error('❌ Error loading royalty balance:', error);
                console.error('Error stack:', error.stack);
                document.getElementById('royaltyBalance').textContent = 'Error loading';
            }
        }

        async function loadCollectionStats() {
            console.log('📊 Loading collection stats...');
            try {
                const collectionData = await rpcCall('sui_getObject', [
                    NFT_COLLECTION_ID,
                    { showContent: true }
                ]);

                console.log('📦 Collection data:', collectionData);

                const fields = collectionData.data.content.fields;
                console.log('📝 Collection fields:', fields);

                document.getElementById('totalMinted').textContent = fields.minted;
                document.getElementById('premintMinted').textContent = fields.premint_minted;
                document.getElementById('phase1Minted').textContent = fields.phase1_minted;
                document.getElementById('phase2Minted').textContent = fields.phase2_minted;
                document.getElementById('phase3Minted').textContent = fields.phase3_minted;
                document.getElementById('publicMinted').textContent = fields.public_minted;
                document.getElementById('remainingNFTs').textContent = fields.available_ids.length;

                console.log('✅ Collection stats updated');

                // Get treasury address
                const treasuryAddr = fields.treasury_address;
                console.log('🏦 Treasury address:', treasuryAddr);

                document.getElementById('treasuryAddress').textContent = treasuryAddr;
                document.getElementById('treasuryExplorer').href =
                    `https://suiscan.xyz/mainnet/account/${treasuryAddr}`;

                // Get treasury balance
                console.log('💰 Fetching treasury balance...');
                const balance = await rpcCall('suix_getBalance', [
                    treasuryAddr,
                    '0x2::sui::SUI'
                ]);

                const suiBalance = (parseInt(balance.totalBalance) / 1_000_000_000).toFixed(2);
                console.log(`💵 Treasury balance: ${balance.totalBalance} MIST (${suiBalance} SUI)`);

                document.getElementById('treasuryBalance').textContent = `${suiBalance} SUI`;
                console.log('✅ Treasury stats updated');
            } catch (error) {
                console.error('❌ Error loading stats:', error);
                console.error('Error stack:', error.stack);
                document.getElementById('treasuryBalance').textContent = 'Error loading';
            }
        }

        async function claimRoyalties() {
            console.log('💸 Starting royalty claim process...');
            try {
                if (!currentWallet || !currentAccount) {
                    throw new Error('Wallet not connected');
                }

                document.getElementById('claimButton').disabled = true;
                document.getElementById('claimButton').textContent = 'Processing...';

                const statusEl = document.getElementById('claimStatus');
                statusEl.className = 'note';
                statusEl.innerHTML = '<div class="note-text">Building transaction...</div>';
                statusEl.classList.remove('hidden');

                console.log('🔨 Building transaction block...');
                console.log('Current wallet:', currentWallet.name);
                console.log('Current account:', currentAccount.address);

                // Build transaction using Transaction builder
                const txb = {
                    kind: 'moveCall',
                    data: {
                        packageObjectId: '0x2',
                        module: 'transfer_policy',
                        function: 'withdraw',
                        typeArguments: [`${PACKAGE_ID}::puppets::PUPPETS_NFT`],
                        arguments: [
                            TRANSFER_POLICY_ID,
                            TRANSFER_POLICY_CAP_ID,
                            null // amount (null means withdraw all)
                        ],
                        gasBudget: 10000000
                    }
                };

                console.log('📝 Transaction block:', txb);

                statusEl.innerHTML = '<div class="note-text">Waiting for wallet approval...</div>';
                console.log('⏳ Waiting for user approval in wallet...');

                // Sign and execute transaction using Wallet Standard API
                const signAndExecuteFeature = currentWallet.features['sui:signAndExecuteTransactionBlock'];

                if (!signAndExecuteFeature) {
                    throw new Error('Wallet does not support transaction signing');
                }

                console.log('🔐 Signing and executing transaction...');

                const result = await signAndExecuteFeature.signAndExecuteTransactionBlock({
                    transactionBlock: txb,
                    account: currentAccount,
                    chain: 'sui:mainnet'
                });

                console.log('✅ Transaction result:', result);

                statusEl.className = 'success';
                statusEl.innerHTML = `
                    <div style="font-weight: bold; margin-bottom: 5px;">✅ Royalties Claimed Successfully!</div>
                    <div>Transaction: <a href="https://suiscan.xyz/mainnet/tx/${result.digest}"
                         target="_blank" style="color: #155724; text-decoration: underline;">
                        ${result.digest.slice(0, 10)}...${result.digest.slice(-8)}
                    </a></div>
                `;

                console.log('🔄 Reloading balances in 2 seconds...');
                // Reload balances
                setTimeout(() => {
                    loadData();
                }, 2000);

            } catch (error) {
                console.error('❌ Error claiming royalties:', error);
                console.error('Error stack:', error.stack);

                let errorMsg = error.message;
                if (error.message.includes('User rejected')) {
                    errorMsg = 'You rejected the transaction';
                }

                const statusEl = document.getElementById('claimStatus');
                statusEl.className = 'error';
                statusEl.innerHTML = `Failed to claim: ${errorMsg}`;

                document.getElementById('claimButton').disabled = false;
                document.getElementById('claimButton').textContent = 'Claim Royalties';
            }
        }

        async function loadData() {
            console.log('📊 Loading all dashboard data...');
            try {
                await Promise.all([
                    loadRoyaltyBalance(),
                    loadCollectionStats()
                ]);
                console.log('✅ All data loaded successfully');
            } catch (error) {
                console.error('❌ Error loading data:', error);
            }
        }

        // Claim button handler
        console.log('🔘 Setting up claim button handler...');
        document.getElementById('claimButton').addEventListener('click', claimRoyalties);

        // Auto-detect Sui Wallet on page load
        window.addEventListener('load', () => {
            console.log('🌍 Window loaded, checking for Sui Wallet...');
            console.log('window.suiWallets:', window.suiWallets);
            console.log('window.suiWallet:', window.suiWallet);
            console.log('window.sui:', window.sui);

            // Give wallet extensions time to inject
            setTimeout(() => {
                console.log('⏰ Delayed wallet check (after 1000ms)...');
                console.log('window.suiWallets:', window.suiWallets);
                console.log('window.suiWallet:', window.suiWallet);
                console.log('window.sui:', window.sui);

                // Check for Wallet Standard API
                const wallets = getWallets();
                const hasWallet = wallets.length > 0;

                if (!hasWallet) {
                    console.warn('⚠️ No Sui Wallet detected on page load');
                    console.log('Debug info:');
                    console.log('- typeof window.suiWallets:', typeof window.suiWallets);
                    console.log('- window.suiWallets?.get:', window.suiWallets?.get);

                    document.querySelector('.wallet-connect').innerHTML +=
                        '<p style="color: #dc3545; margin-top: 15px; font-size: 0.9rem;">⚠️ No Sui Wallet detected.<br>Please install <a href="https://chromewebstore.google.com/detail/sui-wallet/opcgpfmipidbgpenhmajoajpbobppdil" target="_blank" style="color: #dc3545; font-weight: bold;">Sui Wallet extension</a> and refresh this page.</p>';
                } else {
                    console.log('✅ Sui Wallet detected on page load');
                    console.log(`Found ${wallets.length} wallet(s):`, wallets.map(w => w.name));
                }
            }, 1000); // Increased to 1 second to give more time for extension to load
        });

        console.log('✅ Dashboard initialization complete');
    </script>
</body>
</html>
